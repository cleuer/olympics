<!DOCTYPE html>
<meta charset="utf-8">
<style>

    svg {
        width: 100%;
    }

    text {
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }

    .link {
        stroke: #85abff;
        stroke-opacity: .6;
        stroke-width: 2px;
    }
    .goldlink {
        stroke: #ebd200;
        stroke-opacity: .8;
        stroke-width: 4px;
    }
    .silverlink {
        stroke: #c0c0c0;
        stroke-opacity: .8;
        stroke-width: 4px;
    }
    .bronzelink {
        stroke: #cd7f32;
        stroke-opacity: .8;
        stroke-width: 4px;
    }

    .node {
        stroke: #000;
        stroke-width: 1px;
    }


</style>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo4j Movies</title>
</head>

<body>


<form name="myform" onSubmit="return handleClick()">
    <input type="text" id="yearId" placeholder="Add Year&hellip;">
    <input type="text" id="seasonId" placeholder="Add Season&hellip;">
    <input type="text" id="sportId" placeholder="Optional Sport&hellip;">
    <input name="Submit"  type="submit" value="Show Olympics" >
</form>

<ul></ul>


<script src="//d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">

  //default olympics to display on first draw
  var defaultUrl = "/graph?year=1984&season=Summer"

  //color scheme
  //var color = d3.scaleOrdinal(d3.schemeCategory10);
  var c10 = d3.scale.category10();

  //draw the olympic graph. can be user triggered
  function draw(url) {

    console.log("draw olympics");

    var width = 1000;
    var height = 1000;

    var margin = {
      top: 50,
      bottom: 50,
      left: 50,
      right: 50,
    }

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr('transform', 'translate(' + margin.top + ',' + margin.left + ')');

    width = width - margin.left - margin.right;
    height = height - margin.top - margin.bottom;


    var force = d3.layout.force().charge(-200).linkDistance(100).size([width, height]);

    if (url == null) {
        url = defaultUrl
    }
    d3.json(url, function(error, graph) {
        if (error) return;

        force.nodes(graph.nodes).links(graph.links).start();

         var link = svg.selectAll(".link")
                     .data(graph.links).enter()
                     .append("line")
                     .attr("class", function(l) { return linkClass(l); });

         var node = svg.selectAll(".node")
                     .data(graph.nodes).enter().append("g")
                     .attr("class", "node");

        var circle = node.append("circle")
                     .attr("r", function(d) { return circleSize(d); } )
                     .attr("stroke","black")
                     .attr("fill", function(d) { return circleColor(d); } )
                     .call(force.drag);

/* todo: remove me
        var text = node.append("text")
           .attr("y", 15)
           .text(function(d) {
                  var name
                  if (d.type == "Game") {
                     name = d.gameName
                  } else {
                     name = d.name
                  }
                  return name
           });

*/
               // add a label to each node
        var text = node.append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) {
                  var name
                  if (d.type == "Game") {
                     name = d.gameName
                  } else {
                     name = d.name
                  }
                  return name
         })
        .style("stroke", "black")
        .style("stroke-width", 0.5)
        .style("fill", function(d) { return circleColor(d); });



        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

             node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        });
    });
    return false;
  }

  draw();

    //allow user to redraw with different parameters
    function handleClick(event){
       console.log(event);
       var year=document.getElementById("yearId").value
       var season=document.getElementById("seasonId").value
       var sport=document.getElementById("sportId").value
       //default 1988 Summer Olympics
       var url = defaultUrl
       if (year != null && season != null) {
              var url = "/graph?year="+year+"&season="+season+"&sport="+sport;
              console.log("url for user request: "+url);
       }
       d3.select("svg").remove();
       draw(url);
       return false;
  }

     //unique classes to show Gold, Silver, Bronze medals
     function linkClass(l) {
       if (l.type == "PARTICIPATED_IN") {
          if (l.medal == null) {
             return "link";
           } else if (l.medal == "Gold") {
             return "goldlink";
           } else if (l.medal == "Silver") {
             return "silverlink";
           } else if (l.medal == "Bronze") {
             return "bronzelink";
           }
        }
       return "link";
     }


     //size circle smaller for atheletes
     function circleSize(d) {
       if (d.type == "Athlete") {
         return 8;
       } else if (d.type == "Event") {
         return 16;
       } else if (d.type == "Game") {
         return 32;
       }
     }
      //color categories for games, events and athletes
      function circleColor(d) {
       if (d.type == "Event") {
         return c10(d.sportGroup);
       } else if (d.type == "Athlete") {
         if (d.sex == "Female") {
           return "#990099"; //purple
         } else {
           return "#3366cc"; //blue
         }
         return "lightblue";
       } else if (d.type == "Game") {
          //official Olympic green!
         return "#009F3D";
       }
     }

</script>
